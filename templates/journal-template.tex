% Journal Template for Pandoc
% Optimized for print-ready PDF output

\documentclass[8pt,twoside,openany]{book}

% ============================================================================
% PACKAGES
% ============================================================================

% Fonts and Typography
\usepackage{fontspec}
\usepackage{microtype}
\usepackage{xspace}
\setmainfont{Corundum Text Book}[
  BoldFont={Corundum Text Bold}  % or whatever the bold variant is called
]
\setsansfont{Helvetica Neue}
\setmonofont[Scale=0.9]{Menlo}

% Page Layout
\usepackage[
  paperwidth=6in,
  paperheight=9in,
  top=0.75in,
  bottom=0.75in,
  inner=0.875in,
  outer=0.625in,
  bindingoffset=0.25in
]{geometry}
% Prevent vertical stretching to fill pages
\raggedbottom
% Prevent orphans (single line at bottom of page) and widows (single line at top of page)
\widowpenalty=10000
\clubpenalty=10000
% Prevent page breaks immediately after section headings
\usepackage{needspace}
\makeatletter
\renewcommand\section{\@startsection{section}{1}{\z@}%
  {-3.5ex \@plus -1ex \@minus -.2ex}%
  {2.3ex \@plus.2ex}%
  {\needspace{5\baselineskip}\normalfont\Large\bfseries\color{headingcolor}}}
\makeatother

% Paragraph spacing
\setlength{\parskip}{0.8\baselineskip}  % Space between paragraphs
\setlength{\parindent}{0pt}              % No paragraph indentation

% Tight justification (already have microtype, but ensure settings)
\tolerance=1
\emergencystretch=\maxdimen
\hyphenpenalty=10000
\hbadness=10000

% Prevent floats from crossing section boundaries
\usepackage[section]{placeins}

% No numbering for sections
\setcounter{secnumdepth}{0}
\usepackage{titlesec}
\titleformat{\chapter}[block]{\normalfont\Large\bfseries}{}{0pt}{}
\titlespacing*{\chapter}{0pt}{0pt}{0.5em}

% Colors
\usepackage{xcolor}
\definecolor{tagcolor}{RGB}{100,149,237}      % Cornflower blue for tags
\definecolor{namecolor}{RGB}{220,20,60}       % Crimson for names
\definecolor{linkcolor}{RGB}{70,70,120}      % Steel blue for links
\definecolor{headingcolor}{RGB}{0,0,0}     % Black
\definecolor{tag-default}{RGB}{100,149,237}            % Cornflower blue

% Headers and Footers
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
%\fancyhead[LE,RO]{\small\textit{\leftmark}}
%\fancyhead[RO]{\small\textit{\rightmark}}
\fancyfoot[LO,RE]{\small\textit{\leftmark}}
\fancyfoot[LE,RO]{\thepage}
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0.4pt}

% Chapter and Section Styling
\usepackage{titlesec}
% title stilling. Remove "chapter X". Leave title only.
\titleformat{\chapter}[hang]
  {\normalfont\Huge\bfseries}
  {}{0pt}{}
\titlespacing*{\chapter}
  {0pt}{-20pt}{1.5em} % tight top/bottom spacing; tweak as you like
% section stylling. Adjust font size and color
\titleformat{\section}
  {\normalfont\Large\bfseries\color{headingcolor}\raggedright}
  {\thesection}{1em}{}
\titlespacing{\section}{0pt}{5pt}{5pt}
% subsection styling. Adjust font size and color
\titleformat{\subsection}
  {\normalfont\large\bfseries\color{headingcolor}\raggedright}
  {\thesubsection}{1em}{}

% --- prevent page break before chapters (book/report insert a clearpage) ---
% \usepackage{etoolbox}
% \makeatletter
% \patchcmd{\chapter}
%  {\if@openright\cleardoublepage\else\clearpage\fi}{}{}{}
% \makeatother

% --- make running headers show only the chapter title (not "Chapter N") ---
\makeatletter
\renewcommand{\chaptermark}[1]{\markboth{#1}{}}
\makeatother
  
% --- ToC settings ---
% show only chapters in the table of contents
\setcounter{tocdepth}{0}  

% Lists
\usepackage{enumitem}
\setlist{nosep, leftmargin=*}

% Tight list support (Pandoc generates this)
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

% Task list support with nicer boxes
\usepackage{amssymb}
\usepackage{pifont}
\newcommand{\checkbox}{\ensuremath{\square}}
\newcommand{\checkedbox}{\rlap{\ensuremath{\square}}\large\hspace{1pt}\ding{51}}

% Tables
\usepackage{longtable,booktabs,array}
\usepackage{calc}
\usepackage{tabularx}
\setlength{\LTpre}{0pt}
\setlength{\LTpost}{0pt}

% Graphics with smart sizing
\usepackage{graphicx}
\graphicspath{{../assets/}}

% Calculate max dimensions based on orientation
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
% For portrait images (taller than wide), use less height
\def\maxheight{%
  \ifdim\Gin@nat@height>\Gin@nat@width
    0.9\textheight % Portrait: max 50% of page height
  \else
    0.9\textheight % Landscape: max 70% of page height
  \fi
}
\makeatother

% Apply scaling
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}

% Prevent floats from crossing section boundaries
\usepackage[section]{placeins}

% Allow images to float but keep them close to text
\makeatletter
\def\fps@figure{htbp}
\makeatother
\providecommand{\pandocbounded}[1]{#1}

% Hyperlinks
\usepackage{hyperref}
\hypersetup{
  colorlinks=true,
  linkcolor=linkcolor,
  filecolor=linkcolor,
  urlcolor=linkcolor,
  pdfborder={0 0 0},
  breaklinks=true
}


% Format URLs as normal text with line breaks
\urlstyle{same}  % Use same font as surrounding text (not monospace)
\makeatletter
\g@addto@macro{\UrlBreaks}{\UrlOrds}  % Allow breaks at normal characters
\makeatother

% Index Generation - Separate index for each type
\usepackage{imakeidx}
\makeindex[name=people,title=People,columns=2]
\makeindex[name=organizations,title=Organizations,columns=2]
\makeindex[name=projects,title=Projects,columns=2]
\makeindex[name=definitions,title=Definitions,columns=2]
\makeindex[name=books,title=Books,columns=2]
\makeindex[name=tags,title=Tags,columns=2]

% Tag command - takes display name and original name
\makeatletter
\newcommand{\tag}[2]{%
  \@ifundefined{color@tag-#2}{%
    \textcolor{tag-default}{\textbf{\#{}#1}}%
  }{%
    \textcolor{tag-#2}{\textbf{\#{}#1}}%
  }%
  \index[tags]{#1}%
  \xspace%
}
\makeatother

% Person command - takes display name and canonical name
% \person{display name}{canonical name}
% Display name is shown in the text
% Canonical name is used for indexing
\newcommand{\person}[2]{%
  \textcolor{namecolor}{\textbf{#1}}%
  \index[names]{#2}%
  \xspace%
}


% Metadata
$if(title)$
\title{$title$}
$endif$
$if(author)$
\author{$author$}
$endif$
$if(date)$
\date{$date$}
$endif$

% ============================================================================
% DOCUMENT
% ============================================================================

\begin{document}

% Front Matter
\frontmatter

$if(title)$
\date{} 
\maketitle
$endif$

$if(abstract)$
\begin{abstract}
$abstract$
\end{abstract}
$endif$

%\tableofcontents

% Main Content
\mainmatter

$body$

% Back Matter
\backmatter

% Index formatting
\setlength{\columnsep}{2cm}

% Make index entries ragged right (not justified)
\makeatletter
\renewenvironment{theindex}{%
  \if@twocolumn
    \@restonecoltrue\onecolumn
  \else
    \@restonecolfalse
  \fi
  \columnseprule \z@
  \columnsep 2cm
  \twocolumn[\section*{\indexname}]%
  \@mkboth{\MakeUppercase\indexname}{\MakeUppercase\indexname}%
  \thispagestyle{plain}\parindent\z@
  \parskip\z@ \@plus .3\p@\relax
  \raggedright  % This makes entries ragged right instead of justified
  \let\item\@idxitem
}{%
  \if@restonecol\onecolumn\else\clearpage\fi
}
\makeatother

% Manually combine all indexes into one continuous section
\makeatletter
\if@twocolumn
  \@restonecoltrue\onecolumn
\else
  \@restonecolfalse
\fi
\columnseprule \z@
\columnsep 2cm
\twocolumn[\section*{Indexes}]%
\@mkboth{INDEXES}{INDEXES}%
\thispagestyle{plain}\parindent\z@
\parskip\z@ \@plus .3\p@\relax
\raggedright
\let\item\@idxitem

% Temporarily disable theindex environment so we can include .ind files
\let\oldtheindex\theindex
\let\oldendtheindex\endtheindex
\renewenvironment{theindex}{}{}

% People
\subsection*{People}
\InputIfFileExists{people.ind}{}{}

\vspace{2\baselineskip}

% Organizations
\subsection*{Organizations}
\InputIfFileExists{organizations.ind}{}{}

\vspace{2\baselineskip}

% Projects
\subsection*{Projects}
\InputIfFileExists{projects.ind}{}{}

\vspace{2\baselineskip}

% Definitions
\subsection*{Definitions}
\InputIfFileExists{definitions.ind}{}{}

\vspace{2\baselineskip}

% Books
\subsection*{Books}
\InputIfFileExists{books.ind}{}{}

\vspace{2\baselineskip}

% Tags
\subsection*{Tags}
\InputIfFileExists{tags.ind}{}{}

% Restore theindex environment
\let\theindex\oldtheindex
\let\endtheindex\oldendtheindex

\if@restonecol\onecolumn\fi
\makeatother

\end{document}
