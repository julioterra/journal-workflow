% Journal Template for Pandoc
% Optimized for print-ready PDF output

\documentclass[10pt,twoside,openright]{book}

% ============================================================================
% PACKAGES
% ============================================================================

% Fonts and Typography
\usepackage{fontspec}
\usepackage{microtype}
\usepackage{xspace}
\setmainfont{Palatino}
\setsansfont{Helvetica Neue}
\setmonofont[Scale=0.9]{Menlo}



% Page Layout
\usepackage[
  paperwidth=6in,
  paperheight=9in,
  top=0.75in,
  bottom=0.75in,
  inner=0.875in,
  outer=0.625in,
  bindingoffset=0.25in
]{geometry}
% Prevent vertical stretching to fill pages
\raggedbottom
% Prevent orphans (single line at bottom of page) and widows (single line at top of page)
\widowpenalty=10000
\clubpenalty=10000
% Prevent page breaks immediately after section headings
\usepackage{needspace}
\makeatletter
\renewcommand\section{\@startsection{section}{1}{\z@}%
  {-3.5ex \@plus -1ex \@minus -.2ex}%
  {2.3ex \@plus.2ex}%
  {\needspace{5\baselineskip}\normalfont\Large\bfseries\color{headingcolor}}}
\makeatother

% No numbering for sections
\setcounter{secnumdepth}{0}
\usepackage{titlesec}
\titleformat{\chapter}[hang]{\normalfont\huge\bfseries}{}{0pt}{}
\titlespacing*{\chapter}{0pt}{0pt}{1em}


% Colors
\usepackage{xcolor}
\definecolor{tagcolor}{RGB}{100,149,237}      % Cornflower blue for tags
\definecolor{namecolor}{RGB}{220,20,60}       % Crimson for names
\definecolor{linkcolor}{RGB}{70,130,180}      % Steel blue for links
\definecolor{headingcolor}{RGB}{47,79,79}     % Dark slate gray
\definecolor{tag-default}{RGB}{100,149,237}            % Cornflower blue

% Headers and Footers
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
\fancyhead[LE]{\small\textit{\leftmark}}
\fancyhead[RO]{\small\textit{\rightmark}}
\fancyfoot[LE,RO]{\thepage}
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0pt}

% Chapter and Section Styling
\usepackage{titlesec}
\titleformat{\chapter}[display]
  {\normalfont\huge\bfseries\color{headingcolor}}
  {\chaptertitlename\ \thechapter}{20pt}{\Huge}
\titleformat{\section}
  {\normalfont\Large\bfseries\color{headingcolor}}
  {\thesection}{1em}{}
\titleformat{\subsection}
  {\normalfont\large\bfseries\color{headingcolor}}
  {\thesubsection}{1em}{}

% Lists
\usepackage{enumitem}
\setlist{nosep, leftmargin=*}

% Tables
\usepackage{longtable,booktabs,array}
\usepackage{calc}
\usepackage{tabularx}
\setlength{\LTpre}{0pt}
\setlength{\LTpost}{0pt}

% Graphics with smart sizing
\usepackage{graphicx}
\graphicspath{{../assets/}}

% Calculate max dimensions based on orientation
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
% For portrait images (taller than wide), use less height
\def\maxheight{%
  \ifdim\Gin@nat@height>\Gin@nat@width
    0.35\textheight % Portrait: max 50% of page height
  \else
    0.5\textheight % Landscape: max 70% of page height
  \fi
}
\makeatother

% Apply scaling
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}

% Allow images to float but keep them close to text
\makeatletter
\def\fps@figure{htbp}
\makeatother
\providecommand{\pandocbounded}[1]{#1}

% Hyperlinks
\usepackage{hyperref}
\hypersetup{
  colorlinks=true,
  linkcolor=linkcolor,
  filecolor=linkcolor,
  urlcolor=linkcolor,
  pdfborder={0 0 0},
  breaklinks=true
}

% Index Generation
\usepackage{imakeidx}
\makeindex[name=names,title=Index of Names]
\makeindex[name=tags,title=Index of Tags]

% Tag command - takes display name and original name
\makeatletter
\newcommand{\tag}[2]{%
  \@ifundefined{color@tag-#2}{%
    \textcolor{tag-default}{\textbf{\#{}#1}}%
  }{%
    \textcolor{tag-#2}{\textbf{\#{}#1}}%
  }%
  \index[tags]{#1}%
  \space% Add space after each tag
}
\makeatother

% Person command - takes display name and canonical name
% \person{display name}{canonical name}
% Display name is shown in the text
% Canonical name is used for indexing
\newcommand{\person}[2]{%
  \textcolor{namecolor}{\textbf{#1}}%
  \index[names]{#2}%
  \xspace%
}

% Metadata
$if(title)$
\title{$title$}
$endif$
$if(author)$
\author{$author$}
$endif$
$if(date)$
\date{$date$}
$endif$

% ============================================================================
% DOCUMENT
% ============================================================================

\begin{document}

% Front Matter
\frontmatter

$if(title)$
\maketitle
$endif$

$if(abstract)$
\begin{abstract}
$abstract$
\end{abstract}
$endif$

\tableofcontents

% Main Content
\mainmatter

$body$

% Back Matter
\backmatter

% Print indexes
\printindex[names]
\printindex[tags]

\end{document}
