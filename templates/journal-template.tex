% Journal Template for Pandoc
% Optimized for print-ready PDF output

\documentclass[8pt,twoside,openany]{book}

% ============================================================================
% PACKAGES
% ============================================================================

% Fonts and Typography
\usepackage{fontspec}
\usepackage{microtype}
\usepackage{xspace}

% LuaLaTeX emoji font fallback configuration
% Apple Color Emoji for emojis, Wingdings 2 for checked boxes, Menlo for other symbols
\directlua{
  luaotfload.add_fallback("emojifallback", {
    "Apple Color Emoji:mode=harf;",
    "Wingdings 2:mode=node;",
    "Menlo:mode=node;"
  })
}

% Use Verdigris MVB Pro Text with emoji fallback (using filenames)
\setmainfont{VerdigrisMVBProText-Rg}[
  Extension={.otf},
  BoldFont={VerdigrisMVBProText-Bd},
  ItalicFont={VerdigrisMVBProText-It},
  BoldItalicFont={VerdigrisMVBProText-BdIt},
  RawFeature={fallback=emojifallback}
]
\setsansfont{Helvetica Neue}
\setmonofont[Scale=0.9]{Menlo}
\newfontfamily\wingdingsii{Wingdings 2}

% Table font - using Helvetica Neue (clean, modern, reliable with all glyphs)
% Note: Host Grotesk was tested but has missing glyph issues with quotation marks
\let\tablefont\sffamily

% Page Layout
\usepackage[
  paperwidth=$paperwidth$,
  paperheight=$paperheight$,
  top=$if(geometry.top)$$geometry.top$$else$0.75in$endif$,
  bottom=$if(geometry.bottom)$$geometry.bottom$$else$0.75in$endif$,
  inner=$if(geometry.inner)$$geometry.inner$$else$0.875in$endif$,
  outer=$if(geometry.outer)$$geometry.outer$$else$0.625in$endif$,
  bindingoffset=$if(geometry.bindingoffset)$$geometry.bindingoffset$$else$0.25in$endif$
]{geometry}
% Prevent vertical stretching to fill pages
\raggedbottom
% Prevent orphans (single line at bottom of page) and widows (single line at top of page)
\widowpenalty=10000
\clubpenalty=10000
% Prevent page breaks immediately after section headings
\usepackage{needspace}
\makeatletter
\renewcommand\section{\@startsection{section}{1}{\z@}%
  {-3.5ex \@plus -1ex \@minus -.2ex}%
  {2.3ex \@plus.2ex}%
  {\needspace{5\baselineskip}\normalfont\Large\bfseries\color{headingcolor}}}
\makeatother

% Line spacing - slightly increased for better readability
\linespread{1.10}

% Paragraph spacing
\setlength{\parskip}{0.8\baselineskip}  % Space between paragraphs
\setlength{\parindent}{0pt}              % No paragraph indentation

% Tight justification (already have microtype, but ensure settings)
\tolerance=1
\emergencystretch=\maxdimen
\hyphenpenalty=10000
\hbadness=10000

% Prevent floats from crossing section boundaries
\usepackage[section]{placeins}

% Allow deferred content (for landscape tables)
\usepackage{afterpage}

% No numbering for sections
\setcounter{secnumdepth}{0}
\usepackage{titlesec}
\titleformat{\chapter}[block]{\normalfont\Large\bfseries}{}{0pt}{}
\titlespacing*{\chapter}{0pt}{0pt}{0.5em}

% Colors
\usepackage{xcolor}
\definecolor{linkcolor}{RGB}{0,0,0}      % Black for links (same as text)
\definecolor{headingcolor}{RGB}{0,0,0}     % Black

% Tag background colors (for highlighting)
\definecolor{tag-bg-default}{RGB}{220,235,255}     % Light blue highlight (default)

% Define custom highlight colors for specific tags below:
% Emotions - negative (red/pink tones)
\definecolor{tag-bg-anxious}{RGB}{255,200,200}     % Light red
\definecolor{tag-bg-angry}{RGB}{255,180,180}       % Slightly darker red
\definecolor{tag-bg-frustrated}{RGB}{255,210,210}  % Pink
\definecolor{tag-bg-sad}{RGB}{200,200,255}         % Light blue
\definecolor{tag-bg-afraid}{RGB}{255,220,220}      % Very light red

% Emotions - positive (green/blue tones)
\definecolor{tag-bg-grateful}{RGB}{200,255,200}    % Light green
\definecolor{tag-bg-excited}{RGB}{255,240,200}     % Light orange
\definecolor{tag-bg-proud}{RGB}{220,255,220}       % Lighter green
\definecolor{tag-bg-joy}{RGB}{255,255,200}         % Light yellow-green

% Categories (neutral tones)
\definecolor{tag-bg-parenting}{RGB}{220,220,255}   % Light purple
\definecolor{tag-bg-WorkStuff}{RGB}{200,230,255}   % Light blue
\definecolor{tag-bg-marriage}{RGB}{255,220,240}    % Light pink
\definecolor{tag-bg-fail}{RGB}{255,190,190}        % Red (for tracking failures)
\definecolor{tag-bg-win}{RGB}{210,255,210}         % Green (for wins)

% Headers and Footers
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
% Header: Chapter title centered in small caps
\fancyhead[C]{\small\textsc{\leftmark}}
% Header: Page numbers in outer corners
\fancyhead[LE,RO]{\thepage}
% Rule under header - thinner line
\renewcommand{\headrulewidth}{0.2pt}
\renewcommand{\footrulewidth}{0pt}
% Add space below header
\setlength{\headsep}{18pt}

% Chapter and Section Styling
\usepackage{titlesec}
% title stilling. Remove "chapter X". Leave title only.
% Font size reduced by ~30% from original (using \LARGE instead of \Huge)
% All headings centered
\titleformat{\chapter}[block]
  {\normalfont\LARGE\bfseries\centering}
  {}{0pt}{}
\titlespacing*{\chapter}
  {0pt}{30pt}{3em} % moved down more on page and added space before content
% section stylling. 2pt larger than body (body is 8pt, so sections are 10pt)
\titleformat{\section}
  {\fontseries{sb}\fontsize{10pt}{12pt}\selectfont\color{headingcolor}\centering}
  {\thesection}{1em}{}
\titlespacing{\section}{0pt}{5pt}{5pt}
% subsection styling. 2pt larger than body (body is 8pt, so subsections are 10pt)
\titleformat{\subsection}
  {\fontseries{sb}\fontsize{10pt}{12pt}\selectfont\color{headingcolor}\centering}
  {\thesubsection}{1em}{}

% --- prevent page break before chapters (book/report insert a clearpage) ---
% \usepackage{etoolbox}
% \makeatletter
% \patchcmd{\chapter}
%  {\if@openright\cleardoublepage\else\clearpage\fi}{}{}{}
% \makeatother

% --- make running headers show only the chapter title (not "Chapter N") ---
\makeatletter
\renewcommand{\chaptermark}[1]{\markboth{#1}{}}
\makeatother
  
% --- ToC settings ---
% show only chapters in the table of contents
\setcounter{tocdepth}{0}  

% Lists
\usepackage{enumitem}
\setlist{nosep, leftmargin=*}
\setlist[itemize,2]{leftmargin=2em}
\setlist[enumerate,2]{leftmargin=2em}
\setlist[itemize,3]{leftmargin=2em}
\setlist[enumerate,3]{leftmargin=2em}
\setlist[itemize,4]{leftmargin=2em}
\setlist[enumerate,4]{leftmargin=2em}

% Wingdings 2 bullets (scaled to match checkbox size: 0.7, raised 0.15ex)
\renewcommand{\labelitemi}{\raisebox{0.15ex}{\scalebox{0.7}{{\wingdingsii\symbol{"F0E0}}}}}
\renewcommand{\labelitemii}{\raisebox{0.15ex}{\scalebox{0.7}{{\wingdingsii\symbol{"F0DA}}}}}
\renewcommand{\labelitemiii}{\raisebox{0.15ex}{\scalebox{0.7}{{\wingdingsii\symbol{"F0D4}}}}}
\renewcommand{\labelitemiv}{\raisebox{0.15ex}{\scalebox{0.7}{{\wingdingsii\symbol{"F0CD}}}}}

% Checkbox list environment
\newenvironment{checkboxlist}{%
  \begin{itemize}[leftmargin=1.1em]%
}{%
  \end{itemize}%
}

% Tight list support (Pandoc generates this)
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

% Tables
\usepackage{longtable,booktabs,array}
\usepackage{calc}
\usepackage{tabularx}
\usepackage{caption}  % For caption formatting
\usepackage{pdflscape}  % For landscape table rotation
\usepackage[table]{xcolor}  % For zebra striping
\setlength{\LTpre}{0pt}
\setlength{\LTpost}{0pt}
% Define 'none' counter for uncaptioned tables (Pandoc compatibility)
\newcounter{none}

% Configure table caption styling
% Use main serif font, footnotesize (8pt, one size larger than table content), and bold
\DeclareCaptionFont{tablecaptionfont}{\footnotesize\bfseries}
\captionsetup[table]{
  font=tablecaptionfont,
  labelfont=tablecaptionfont,
  textfont=tablecaptionfont
}

% Define color for table rules (borders and column separators)
\definecolor{tablerule}{RGB}{0,0,0}      % Black for rules
\definecolor{tablerowstripe}{RGB}{242,242,242}  % Very light gray for zebra striping
\definecolor{tableheadertext}{RGB}{40,40,40}  % Dark gray for header text
\definecolor{tableheaderbg}{RGB}{220,220,220}  % Light gray for header background

% Set default color for table rules
\arrayrulecolor{tablerule}

% Graphics with smart sizing
\usepackage{graphicx}
\graphicspath{{../assets/}}

% Calculate max dimensions based on orientation
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
% For portrait images (taller than wide), use less height
\def\maxheight{%
  \ifdim\Gin@nat@height>\Gin@nat@width
    0.9\textheight % Portrait: max 50% of page height
  \else
    0.9\textheight % Landscape: max 70% of page height
  \fi
}
\makeatother

% Apply scaling
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}

% Prevent floats from crossing section boundaries
\usepackage[section]{placeins}

% Allow images to float but keep them close to text
\makeatletter
\def\fps@figure{htbp}
\makeatother
\providecommand{\pandocbounded}[1]{#1}

% Add spacing around figures (space above and below when placed in text)
\setlength{\intextsep}{24pt plus 4pt minus 2pt}  % Space above/below in-text figures
\setlength{\textfloatsep}{18pt plus 4pt minus 2pt}  % Space for top/bottom floats

% Hyperlinks
\usepackage{hyperref}
\hypersetup{
  colorlinks=true,
  linkcolor=linkcolor,
  filecolor=linkcolor,
  urlcolor=linkcolor,
  pdfborder={0 0 0},
  breaklinks=true,
  hyperindex=true
}


% Format URLs as normal text with line breaks
\urlstyle{same}  % Use same font as surrounding text (not monospace)
\makeatletter
\g@addto@macro{\UrlBreaks}{\UrlOrds}  % Allow breaks at normal characters
\makeatother

% Endnotes - convert footnotes to endnotes at back of book
\usepackage{endnotes}
\let\footnote=\endnote  % Redirect all footnotes to endnotes

% Index Generation - Separate index for each type
\usepackage{imakeidx}
\makeindex[name=people,title=People,columns=2]
\makeindex[name=organizations,title=Organizations,columns=2]
\makeindex[name=projects,title=Projects,columns=2]
\makeindex[name=definitions,title=Definitions,columns=2]
\makeindex[name=books,title=Books,columns=2]
\makeindex[name=tags,title=Tags,columns=2]

% Tag command - takes display name and original name
% Uses background highlighting instead of text color
% Adjusted to prevent extra vertical spacing from colorbox
\makeatletter
\newcommand{\tag}[2]{%
  % Save current fboxsep and set minimal padding
  \setlength{\fboxsep}{2pt}%
  \@ifundefined{color@tag-bg-#2}{%
    % Use default background color if tag-specific color not defined
    \raisebox{0pt}[\height][0pt]{\colorbox{tag-bg-default}{\#{}#1}}%
  }{%
    % Use tag-specific background color
    \raisebox{0pt}[\height][0pt]{\colorbox{tag-bg-#2}{\#{}#1}}%
  }%
  \index[tags]{#1}%
  \xspace%
}
\makeatother

% Person command - takes display name and canonical name
% \person{display name}{canonical name}
% Display name is shown in the text
% Canonical name is used for indexing
\newcommand{\person}[2]{%
  \textbf{#1}%
  \index[names]{#2}%
  \xspace%
}


% Metadata
$if(title)$
\title{$title$}
$endif$
$if(author)$
\author{$author$}
$endif$
$if(date)$
\date{$date$}
$endif$
$if(dates)$
\newcommand{\dates}{$dates$}
$endif$
$if(volume)$
\newcommand{\volume}{$volume$}
$endif$

% ============================================================================
% DOCUMENT
% ============================================================================

\begin{document}

% Front Matter
\frontmatter

% Custom title page
$if(title)$
\begin{titlepage}
\centering

\vspace*{\fill}

% Title - very large bold
{\fontsize{27pt}{32pt}\selectfont\bfseries $title$\par}
\vspace{-0.5em}

% Small rule between title and author (hairline)
{\centering\rule{2.5in}{0.1pt}\par}
\vspace{1em}

% Page dimensions - medium italic (commented out - for testing only)
%$if(pagedimensions)$
%{\large\itshape $pagedimensions$\par}
%\vspace{0.5em}
%$endif$

% Author - medium normal case
$if(author)$
{\fontsize{15pt}{18pt}\selectfont $author$\par}
%\vspace{4em}
$endif$


\vspace*{\fill}
\vspace*{\fill}

% Year - large bold
$if(year)$
{\Huge\bfseries $year$\par}
\vspace{0.5em}
$endif$

% Month Range - small capitalized
$if(start_month)$
$if(end_month)$
{\normalsize $start_month$ - $end_month$\par}
\vspace{4em}
$endif$
$endif$


\end{titlepage}
$endif$

$if(abstract)$
\begin{abstract}
$abstract$
\end{abstract}
$endif$

%\tableofcontents

% Main Content
\mainmatter

$body$

% Back Matter
\backmatter

% Ensure Notes starts on a right (odd) page with blank left page
\clearpage
\ifodd\value{page}
  % About to write on odd page - previous even page has content
  % Need to add blank odd, then blank even, so Notes starts on next odd
  \thispagestyle{empty}\mbox{}\clearpage
  \thispagestyle{empty}\mbox{}\clearpage
\else
  % About to write on even page - previous odd page has content
  % Add blank even page, Notes starts on next odd
  \thispagestyle{empty}\mbox{}\clearpage
\fi

% Print endnotes (HTTP/HTTPS link references)
\begingroup
\parindent 0pt
\parskip 2ex
\def\enotesize{\normalsize}
\theendnotes
\thispagestyle{plain}  % No header on Notes section
\endgroup

\clearpage

% Index formatting
\setlength{\columnsep}{2cm}

% Make index entries ragged right (not justified)
\makeatletter
\renewenvironment{theindex}{%
  \if@twocolumn
    \@restonecoltrue\onecolumn
  \else
    \@restonecolfalse
  \fi
  \columnseprule \z@
  \columnsep 2cm
  \twocolumn[\section*{\indexname}]%
  \@mkboth{\MakeUppercase\indexname}{\MakeUppercase\indexname}%
  \thispagestyle{plain}\parindent\z@
  \parskip\z@ \@plus .3\p@\relax
  \raggedright  % This makes entries ragged right instead of justified
  \let\item\@idxitem
}{%
  \if@restonecol\onecolumn\else\clearpage\fi
}
\makeatother

% Ensure index starts on a right (odd) page with blank left page
\clearpage
\ifodd\value{page}
  % About to write on odd page - previous even page has content
  % Need to add blank odd, then blank even, so index starts on next odd
  \thispagestyle{empty}\mbox{}\clearpage
  \thispagestyle{empty}\mbox{}\clearpage
\else
  % About to write on even page - previous odd page has content
  % Add blank even page, index starts on next odd
  \thispagestyle{empty}\mbox{}\clearpage
\fi

% Manually combine all indexes into one continuous section
\makeatletter
\if@twocolumn
  \@restonecoltrue\onecolumn
\else
  \@restonecolfalse
\fi
\columnseprule \z@
\columnsep 2cm
\twocolumn[\section*{Indexes}\vspace{4\baselineskip}]%
\@mkboth{Indexes}{Indexes}%
\thispagestyle{plain}\parindent\z@
\parskip\z@ \@plus .3\p@\relax
\raggedright
\let\item\@idxitem

% Temporarily disable theindex environment so we can include .ind files
\let\oldtheindex\theindex
\let\oldendtheindex\endtheindex
\renewenvironment{theindex}{}{}
% Remove extra spacing between alphabetical groups
\renewcommand{\indexspace}{}

% Helper command to only print index section if it has content
\newif\ifhasitems
\newcommand{\printindexsection}[2]{%
  % First pass: check if file has \item commands
  \hasitemsfalse
  \let\olditemcheck\item
  \def\item{\global\hasitemstrue\olditemcheck}%
  \setbox0=\vbox{\InputIfFileExists{#2.ind}{}{}}%
  \let\item\olditemcheck
  % Second pass: if it has items, actually print it
  \ifhasitems
    \subsection*{#1}%
    \InputIfFileExists{#2.ind}{}{}%
    \vspace{2\baselineskip}%
  \fi
}

% Print each index section (only if non-empty, in alphabetical order)
\printindexsection{Books}{books}
\printindexsection{Definitions}{definitions}
\printindexsection{Organizations}{organizations}
\printindexsection{People}{people}
\printindexsection{Projects}{projects}
\printindexsection{Tags}{tags}

% Restore theindex environment
\let\theindex\oldtheindex
\let\endtheindex\oldendtheindex

\if@restonecol\onecolumn\fi
\makeatother

\end{document}
